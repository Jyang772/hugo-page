<!doctype html>
<html lang='en-us'><head>
<script async src="https://www.googletagmanager.com/gtag/js?id=G-WBN59M8Y5S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-WBN59M8Y5S');
</script>


<script type="text/javascript">
  (function(m,e,t,r,i,k,a){m[i]=m[i]||function(){(m[i].a=m[i].a||[]).push(arguments)};
  m[i].l=1*new Date();k=e.createElement(t),a=e.getElementsByTagName(t)[0],k.async=1,k.src=r,a.parentNode.insertBefore(k,a)})
  (window, document, "script", "https://mc.yandex.ru/metrika/tag.js", "ym");

  ym(53961409, "init", {
       clickmap:true,
       trackLinks:true,
       accurateTrackBounce:true,
       webvisor:true
  });
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/53961409" style="position:absolute; left:-9999px;" alt="" /></div></noscript>
<meta charset="utf-8">

  
  <link rel="stylesheet" href="/style.min.a3a4a7a8e8602aaa85b7cb3d655edde028ac80d73f2a97389e2cbcf995dd672d.css" integrity="sha256-o6SnqOhgKqqFt8s9ZV7d4CisgNc/Kpc4niy8&#43;ZXdZy0=">
  <link rel="stylesheet" href="/syntax.css" id="syntax-theme">

  <link rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
  <script src="https://tikzjax.com/v1/tikzjax.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lunr.js/2.3.9/lunr.min.js"></script>
  <script src="/scripts/lunr.stemmer.support.min.js"></script>
  <script src="/scripts/lunr.ru.min.js"></script>
  <script src="/scripts/lunr.multi.min.js"></script>

  
  <link rel="stylesheet" id="theme">

  <script>
    function toggleSidebar() {
      console.log("Toggling sidebar visibility")
      var sidebar = document.getElementById('sidebar')
      var wrapper = document.getElementById('wrapper')
      if (sidebar.classList.contains('sidebar-toggled') || window.getComputedStyle(sidebar).display == 'block') { 
        sidebar.classList.toggle('sidebar-hidden')
        wrapper.classList.toggle('sidebar-hidden')
      }
      sidebar.classList.add('sidebar-toggled')
      wrapper.classList.add('sidebar-toggled')
    }

    function switchTheme(theme) {
      console.log("Changing theme:", theme)
      document.getElementById('theme').href = (theme == 'dark' ? "\/dark.min.b3ae1169831434b11b48de5b3e3210547eea6b7884c295ab0030cb973ea0dc49.css" : "")
      document.getElementById('syntax-theme').href = (theme == 'dark' ? '/syntax-dark.css' : '/syntax.css')
      localStorage.setItem('theme', theme)
    }

    async function toggleSearch() {
      console.log("Toggling search")
      
      var searchDiv = document.getElementById('search')
      if (window.getComputedStyle(searchDiv).display == 'none') {
        searchDiv.style.display = 'block'
        window.scrollTo({ top: 0 });
        document.getElementById('search-bar').focus()
      } else {
        searchDiv.style.display = 'none'  
      }

      if (!index) {
        console.log("Fetching index")
        const response = await fetch('/searchindex.json')
        const pages = await response.json()
        index = lunr(function() {
          this.use(lunr.multiLanguage('en', 'ru'))
          this.field('title', {
            boost: 5
          })
          this.field('content', {
            boost: 1
          })
          pages.forEach(function(doc) {
            this.add(doc)
            articles.push(doc)
          }, this)
        })
        console.log("Ready to search")
      }
    }

    var articles = []
    var index = undefined

    function search() {
      var query = document.getElementById('search-bar').value
      var resultsDiv = document.getElementById('search-results')
      var countDiv = document.getElementById('search-count')
      
      if (query == '') {
        resultsDiv.innerHTML = ''
        countDiv.innerHTML = ''
        return
      }
      
      var results = index.search(query)

      countDiv.innerHTML = 'Found <b>' + results.length + '</b> pages'

      let resultList = ''

      for (const n in results) {
        const item = articles[results[n].ref]
        resultList += '<li><a href="' + item.path + '">' + item.title + '</a> <p>'
        const text = item.content

        const contextLimit = 80

        if (text.includes(query)) {
          const start = text.indexOf(query)
          if (start > contextLimit)
            resultList += '…'
          resultList += text.substring(start - contextLimit, start)
                      + '<b>' + query + '</b>' + text.substring(start + query.length, start + query.length + contextLimit)

        } else {
          resultList += text.substring(0, contextLimit * 2)
        }
        resultList += '…</p></li>'
      }

      resultsDiv.innerHTML = resultList
    }

    if (localStorage.getItem('theme') == 'dark') {
      switchTheme('dark')
    }

    window.addEventListener('load', function() {
      var el = document.getElementById("active-element")
      
      if (el) {
        el.scrollIntoView({block: "center"})
      }
      

    })

    window.addEventListener('scroll', function() {
      var menu = document.getElementById('menu')
      if (window.scrollY < 120) {
        
        menu.classList.remove('scrolled')
      } else {
        
        menu.classList.add('scrolled')
      }
    })

    window.addEventListener('keydown', function(e) {
      if (e.altKey) { return }
      if (document.activeElement.tagName == 'INPUT') { return }
      if (e.key == 'ArrowLeft') {
        document.getElementById('prev-article').click()
      } else if (e.key == 'ArrowRight') {
        document.getElementById('next-article').click()
      }
    })
  </script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"
  onload="renderMathInElement(document.body, {
    delimiters: [
      {left: '$$', right: '$$', display: true},
      {left: '$', right: '$', display: false}
    ]
  })"></script>

  
  <title>Statistical Profiling - Algorithmica</title>
</head>
<body><nav id='sidebar' >
  
  
  <div class='title'>
    <a href='/'>Algorithmica</a>
    
      
        
        <span class='slash'>/</span>
        <a href='/hpc/' class='divisionAbbr'
           >
          HPC
        </a>
      
    
  </div>
  <ul>
    
      
        
          <li class='part'>Performance Engineering</li>
        
        <li class=' '><a href='/hpc/complexity/'
          
          >Complexity Models</a></li>
        
          <ol>
            
              <li ><a href='/hpc/complexity/hardware/'
                
                >Modern Hardware</a></li>
            
              <li ><a href='/hpc/complexity/languages/'
                
                >Programming Languages</a></li>
            
          </ol>
        
      
        
        <li class=' '><a href='/hpc/architecture/'
          
          >Computer Architecture</a></li>
        
          <ol>
            
              <li ><a href='/hpc/architecture/isa/'
                
                >Instruction Set Architectures</a></li>
            
              <li ><a href='/hpc/architecture/assembly/'
                
                >Assembly Language</a></li>
            
              <li ><a href='/hpc/architecture/loops/'
                
                >Loops and Conditionals</a></li>
            
              <li ><a href='/hpc/architecture/functions/'
                
                >Functions and Recursion</a></li>
            
              <li ><a href='/hpc/architecture/indirect/'
                
                >Indirect Branching</a></li>
            
              <li ><a href='/hpc/architecture/layout/'
                
                >Machine Code Layout</a></li>
            
          </ol>
        
      
        
        <li class=' '><a href='/hpc/pipelining/'
          
          >Instruction-Level Parallelism</a></li>
        
          <ol>
            
              <li ><a href='/hpc/pipelining/hazards/'
                
                >Pipeline Hazards</a></li>
            
              <li ><a href='/hpc/pipelining/branching/'
                
                >The Cost of Branching</a></li>
            
              <li ><a href='/hpc/pipelining/branchless/'
                
                >Branchless Programming</a></li>
            
              <li ><a href='/hpc/pipelining/tables/'
                
                >Instruction Tables</a></li>
            
              <li ><a href='/hpc/pipelining/throughput/'
                
                >Throughput Computing</a></li>
            
          </ol>
        
      
        
        <li class=' '><a href='/hpc/compilation/'
          
          >Compilation</a></li>
        
          <ol>
            
              <li ><a href='/hpc/compilation/stages/'
                
                >Stages of Compilation</a></li>
            
              <li ><a href='/hpc/compilation/flags/'
                
                >Flags and Targets</a></li>
            
              <li ><a href='/hpc/compilation/situational/'
                
                >Situational Optimizations</a></li>
            
              <li ><a href='/hpc/compilation/contracts/'
                
                >Contract Programming</a></li>
            
              <li ><a href='/hpc/compilation/precalc/'
                
                >Precomputation</a></li>
            
          </ol>
        
      
        
        <li class=' '><a href='/hpc/profiling/'
          
          >Profiling</a></li>
        
          <ol>
            
              <li ><a href='/hpc/profiling/instrumentation/'
                
                >Instrumentation</a></li>
            
              <li ><a href='/hpc/profiling/events/'
                id='active-element'
                >Statistical Profiling</a></li>
            
              <li ><a href='/hpc/profiling/simulation/'
                
                >Program Simulation</a></li>
            
              <li ><a href='/hpc/profiling/mca/'
                
                >Machine Code Analyzers</a></li>
            
              <li ><a href='/hpc/profiling/benchmarking/'
                
                >Benchmarking</a></li>
            
              <li ><a href='/hpc/profiling/noise/'
                
                >Getting Accurate Results</a></li>
            
          </ol>
        
      
        
        <li class=' '><a href='/hpc/arithmetic/'
          
          >Arithmetic</a></li>
        
          <ol>
            
              <li ><a href='/hpc/arithmetic/float/'
                
                >Floating-Point Numbers</a></li>
            
              <li ><a href='/hpc/arithmetic/ieee-754/'
                
                >IEEE 754 Floats</a></li>
            
              <li ><a href='/hpc/arithmetic/errors/'
                
                >Rounding Errors</a></li>
            
              <li ><a href='/hpc/arithmetic/newton/'
                
                >Newton&#39;s Method</a></li>
            
              <li ><a href='/hpc/arithmetic/rsqrt/'
                
                >Fast Inverse Square Root</a></li>
            
              <li ><a href='/hpc/arithmetic/integer/'
                
                >Integer Numbers</a></li>
            
              <li ><a href='/hpc/arithmetic/division/'
                
                >Integer Division</a></li>
            
          </ol>
        
      
        
        <li class=' '><a href='/hpc/number-theory/'
          
          >Number Theory</a></li>
        
          <ol>
            
              <li ><a href='/hpc/number-theory/modular/'
                
                >Modular Arithmetic</a></li>
            
              <li ><a href='/hpc/number-theory/exponentiation/'
                
                >Binary Exponentiation</a></li>
            
              <li ><a href='/hpc/number-theory/euclid-extended/'
                
                >Extended Euclidean Algorithm</a></li>
            
              <li ><a href='/hpc/number-theory/montgomery/'
                
                >Montgomery Multiplication</a></li>
            
          </ol>
        
      
        
        <li class=' '><a href='/hpc/external-memory/'
          
          >External Memory</a></li>
        
          <ol>
            
              <li ><a href='/hpc/external-memory/hierarchy/'
                
                >Memory Hierarchy</a></li>
            
              <li ><a href='/hpc/external-memory/virtual/'
                
                >Virtual Memory</a></li>
            
              <li ><a href='/hpc/external-memory/model/'
                
                >External Memory Model</a></li>
            
              <li ><a href='/hpc/external-memory/sorting/'
                
                >External Sorting</a></li>
            
              <li ><a href='/hpc/external-memory/list-ranking/'
                
                >List Ranking</a></li>
            
              <li ><a href='/hpc/external-memory/policies/'
                
                >Eviction Policies</a></li>
            
              <li ><a href='/hpc/external-memory/oblivious/'
                
                >Cache-Oblivious Algorithms</a></li>
            
              <li ><a href='/hpc/external-memory/locality/'
                
                >Spatial and Temporal Locality</a></li>
            
          </ol>
        
      
        
        <li class=' '><a href='/hpc/cpu-cache/'
          
          >RAM &amp; CPU Caches</a></li>
        
          <ol>
            
              <li ><a href='/hpc/cpu-cache/bandwidth/'
                
                >Memory Bandwidth</a></li>
            
              <li ><a href='/hpc/cpu-cache/latency/'
                
                >Memory Latency</a></li>
            
              <li ><a href='/hpc/cpu-cache/cache-lines/'
                
                >Cache Lines</a></li>
            
              <li ><a href='/hpc/cpu-cache/sharing/'
                
                >Memory Sharing</a></li>
            
              <li ><a href='/hpc/cpu-cache/mlp/'
                
                >Memory-Level Parallelism</a></li>
            
              <li ><a href='/hpc/cpu-cache/prefetching/'
                
                >Prefetching</a></li>
            
              <li ><a href='/hpc/cpu-cache/alignment/'
                
                >Alignment and Packing</a></li>
            
              <li ><a href='/hpc/cpu-cache/pointers/'
                
                >Pointer Alternatives</a></li>
            
              <li ><a href='/hpc/cpu-cache/associativity/'
                
                >Cache Associativity</a></li>
            
              <li ><a href='/hpc/cpu-cache/paging/'
                
                >Memory Paging</a></li>
            
              <li ><a href='/hpc/cpu-cache/aos-soa/'
                
                >AoS and SoA</a></li>
            
          </ol>
        
      
        
        <li class=' '><a href='/hpc/simd/'
          
          >SIMD Parallelism</a></li>
        
          <ol>
            
              <li ><a href='/hpc/simd/intrinsics/'
                
                >Intrinsics and Vector Types</a></li>
            
              <li ><a href='/hpc/simd/moving/'
                
                >Moving Data</a></li>
            
              <li ><a href='/hpc/simd/reduction/'
                
                >Reductions</a></li>
            
              <li ><a href='/hpc/simd/masking/'
                
                >Masking and Blending</a></li>
            
              <li ><a href='/hpc/simd/shuffling/'
                
                >In-Register Shuffles</a></li>
            
              <li ><a href='/hpc/simd/auto-vectorization/'
                
                >Auto-Vectorization and SPMD</a></li>
            
          </ol>
        
      
        
        <li class=' '><a href='/hpc/algorithms/'
          
          >Algorithms Case Studies</a></li>
        
          <ol>
            
              <li ><a href='/hpc/algorithms/gcd/'
                
                >Binary GCD</a></li>
            
              <li ><a href='/hpc/algorithms/factorization/'
                
                >Integer Factorization</a></li>
            
              <li ><a href='/hpc/algorithms/argmin/'
                
                >Argmin with SIMD</a></li>
            
              <li ><a href='/hpc/algorithms/prefix/'
                
                >Prefix Sum with SIMD</a></li>
            
              <li ><a href='/hpc/algorithms/matmul/'
                
                >Matrix Multiplication</a></li>
            
          </ol>
        
      
        
        <li class=' '><a href='/hpc/data-structures/'
          
          >Data Structures Case Studies</a></li>
        
          <ol>
            
              <li ><a href='/hpc/data-structures/binary-search/'
                
                >Binary Search</a></li>
            
              <li ><a href='/hpc/data-structures/s-tree/'
                
                >Static B-Trees</a></li>
            
              <li ><a href='/hpc/data-structures/b-tree/'
                
                >Search Trees</a></li>
            
              <li ><a href='/hpc/data-structures/segment-trees/'
                
                >Segment Trees</a></li>
            
          </ol>
        
      
    
  </ul>
</nav>
<div id='wrapper' ><menu id='menu'>
  
  
  <div class='left'>
    <a>
      <img src='/icons/bars-solid.svg'
           onclick='toggleSidebar()'
           title='open table of contents'>
    </a>
    <a>
      <img src='/icons/adjust-solid.svg'
           style='position: relative; top: -1px'
           onclick='switchTheme(localStorage.getItem("theme") == "dark" ? "light" : "dark")'
           title='dark theme'>
    </a>
    <a>
      <img src='/icons/search-solid.svg'
           onclick='toggleSearch()'
           title='search'>
    </a>
  </div>
  <div class='title'>Statistical Profiling</div>
  <div class='right'>
    <a onClick='window.print()'>
      <img src='/icons/print-solid.svg' title='print'>
    </a>
    <a href='https://prose.io/#algorithmica-org/algorithmica/edit/master//hpc%2fprofiling%2fevents.md'>
      <img src='/icons/edit-solid.svg'
           title='edit'
           style='width: 18px; position: relative; right: -2px; top: -1px'>
    </a>
    <a href='https://github.com/algorithmica-org/algorithmica/blob/master//hpc/profiling/events.md' class='github-main'>
      <img src='/icons/github-brands.svg' title='view on github'>
    </a>
  </div>
</menu>
<main>
        <div id="search">
    <input id="search-bar" type="search" placeholder='Search this book…' oninput="search()">
    <div id="search-count"></div>
    <div id="search-results">
    </div>
</div>
<header>
  
  <h1>Statistical Profiling</h1>
  
    <div class='info'></div>
  
</header>
<article>
  


  
    
    
      
        <p><a href="../instrumentation">Instrumentation</a> is a rather tedious way of doing profiling, especially if you are interested in multiple small sections of the program. And even if it can be partially automated by the tooling, it still won&rsquo;t help you gather some fine-grained statistics because of its inherent overhead.</p>
<p>Another, less invasive approach to profiling is to interrupt the execution of a program at random intervals and look where the instruction pointer is. The number of times the pointer stopped in each function&rsquo;s block would be roughly proportional to the total time spent executing these functions. You can also get some other useful information this way, like finding out which functions are called by which functions by inspecting <a href="/hpc/architecture/functions">the call stack</a>.</p>
<p>This could, in principle, be done by just running a program with <code>gdb</code> and <code>ctrl+c</code>&lsquo;ing it at random intervals but modern CPUs and operating systems provide special utilities for this type of profiling.</p>
<span class='anchor' id="hardware-events"></span>
<h3><a class="anchor-link" href="https://en.algorithmica.org/hpc/profiling/events/#hardware-events">#</a>Hardware Events</h3><p>Hardware <em>performance counters</em> are special registers built into microprocessors that can store the counts of certain hardware-related activities. They are cheap to add on a microchip, as they are basically just binary counters with an activation wire connected to them.</p>
<p>Each performance counter is connected to a large subset of circuitry and can be configured to be incremented on a particular hardware event, such as a branch mispredict or a cache miss. You can reset a counter at the start of a program, run it, and output its stored value at the end, and it will be equal to the exact number of times a certain event has been triggered throughout the execution.</p>
<p>You can also keep track of multiple events by multiplexing between them, that is, stopping the program in even intervals and reconfiguring the counters. The result in this case will not be exact, but a statistical approximation. One nuance here is that its accuracy can’t be improved by simply increasing the sampling frequency because it would affect the performance too much and thus skew the distribution, so to collect multiple statistics, you would need to run the program for longer periods of time.</p>
<p>Overall, event-driven statistical profiling is usually the most effective and easy way to diagnose performance issues.</p>
<span class='anchor' id="profiling-with-perf"></span>
<h3><a class="anchor-link" href="https://en.algorithmica.org/hpc/profiling/events/#profiling-with-perf">#</a>Profiling with perf</h3><p>Performance analysis tools that rely on the event sampling techniques described above are called <em>statistical profilers</em>. There are many of them, but the one we will mainly use in this book is <a href="https://perf.wiki.kernel.org/">perf</a>, which is a statistical profiler shipped with the Linux kernel. On non-Linux systems, you can use <a href="https://software.intel.com/content/www/us/en/develop/tools/oneapi/components/vtune-profiler.html#gs.cuc0ks">VTune</a> from Intel, which provides roughly the same functionality for our purposes. It is available for free, although it is proprietary, and you need to refresh your community license every 90 days, while perf is free as in freedom.</p>
<p>Perf is a command-line application that generates reports based on the live execution of programs. It does not need the source and can profile a very wide range of applications, even those that involve multiple processes and interaction with the operating system.</p>
<p>For explanation purposes, I have written a small program that creates an array of a million random integers, sorts it, and then does a million binary searches on it:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">a</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rand</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">n</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">query</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">lower_bound</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="n">rand</span><span class="p">())</span> <span class="o">-</span> <span class="n">a</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">checksum</span> <span class="o">+=</span> <span class="n">idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">checksum</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>After compiling it (<code>g++ -O3 -march=native example.cc -o run</code>), we can run it with <code>perf stat ./run</code>, which outputs the counts of basic performance events during its execution:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="w"> </span><span class="nt">Performance counter stats for &#39;./run&#39;</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">        </span><span class="m">646.07</span><span class="w"> </span><span class="l">msec task-clock:u              </span><span class="w"> </span><span class="c"># 0.997 CPUs utilized          </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="m">0</span><span class="w">      </span><span class="l">context-switches:u        </span><span class="w"> </span><span class="c"># 0.000 K/sec                  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">             </span><span class="m">0</span><span class="w">      </span><span class="l">cpu-migrations:u          </span><span class="w"> </span><span class="c"># 0.000 K/sec                  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">         </span><span class="m">1</span><span class="p">,</span><span class="m">096</span><span class="w">      </span><span class="l">page-faults:u             </span><span class="w"> </span><span class="c"># 0.002 M/sec                  </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="m">852</span><span class="p">,</span><span class="m">125</span><span class="p">,</span><span class="m">255</span><span class="w">      </span><span class="l">cycles:u                  </span><span class="w"> </span><span class="c"># 1.319 GHz (83.35%)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="m">28</span><span class="p">,</span><span class="m">475</span><span class="p">,</span><span class="m">954</span><span class="w">      </span><span class="l">stalled-cycles-frontend:u </span><span class="w"> </span><span class="c"># 3.34% frontend cycles idle (83.30%)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="m">10</span><span class="p">,</span><span class="m">460</span><span class="p">,</span><span class="m">937</span><span class="w">      </span><span class="l">stalled-cycles-backend:u  </span><span class="w"> </span><span class="c"># 1.23% backend cycles idle (83.28%)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="m">479</span><span class="p">,</span><span class="m">175</span><span class="p">,</span><span class="m">388</span><span class="w">      </span><span class="l">instructions:u            </span><span class="w"> </span><span class="c"># 0.56  insn per cycle         </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">                                               </span><span class="c"># 0.06  stalled cycles per insn (83.28%)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="m">122</span><span class="p">,</span><span class="m">705</span><span class="p">,</span><span class="m">572</span><span class="w">      </span><span class="l">branches:u                </span><span class="w"> </span><span class="c"># 189.925 M/sec (83.32%)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="m">19</span><span class="p">,</span><span class="m">229</span><span class="p">,</span><span class="m">451</span><span class="w">      </span><span class="l">branch-misses:u           </span><span class="w"> </span><span class="c"># 15.67% of all branches (83.47%)</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="m">0.647801770</span><span class="w"> </span><span class="l">seconds time elapsed</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="m">0.647278000</span><span class="w"> </span><span class="l">seconds user</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">   </span><span class="m">0.000000000</span><span class="w"> </span><span class="l">seconds sys</span><span class="w">
</span></span></span></code></pre></div><p>You can see that the execution took 0.53 seconds or 852M cycles at an effective 1.32 GHz clock rate, over which 479M instructions were executed. There were also 122.7M branches, and 15.7% of them were mispredicted.</p>
<p>You can get a list of all supported events with <code>perf list</code>, and then specify a list of specific events you want with the <code>-e</code> option. For example, for diagnosing binary search, we mostly care about cache misses:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="l">&gt; perf stat -e cache-references,cache-misses ./run</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="m">91</span><span class="p">,</span><span class="m">002</span><span class="p">,</span><span class="m">054</span><span class="w">      </span><span class="l">cache-references:u                                          </span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="m">44</span><span class="p">,</span><span class="m">991</span><span class="p">,</span><span class="m">746</span><span class="w">      </span><span class="l">cache-misses:u     </span><span class="w"> </span><span class="c"># 49.440 % of all cache refs</span><span class="w">
</span></span></span></code></pre></div><p>By itself, <code>perf stat</code> simply sets up performance counters for the whole program. It can tell you the total number of branch mispredictions, but it won&rsquo;t tell you <em>where</em> they are happening, let alone <em>why</em> they are happening.</p>
<p>To try the stop-the-world approach we discussed previously, we need to use <code>perf record &lt;cmd&gt;</code>, which records profiling data and dumps it as a <code>perf.data</code> file, and then call <code>perf report</code> to inspect it. I highly advise you to go and try it yourselves because the last command is interactive and colorful, but for those that can&rsquo;t do it right now, I&rsquo;ll try to describe it the best I can.</p>
<p>When you call <code>perf report</code>, it first displays a <code>top</code>-like interactive report that tells you which functions are taking how much time:</p>
<pre tabindex="0"><code>Overhead  Command  Shared Object        Symbol
  63.08%  run      run                  [.] query
  24.98%  run      run                  [.] std::__introsort_loop&lt;...&gt;
   5.02%  run      libc-2.33.so         [.] __random
   3.43%  run      run                  [.] setup
   1.95%  run      libc-2.33.so         [.] __random_r
   0.80%  run      libc-2.33.so         [.] rand
</code></pre><p>Note that, for each function, just its <em>overhead</em> is listed and not the total running time (e.g., <code>setup</code> includes <code>std::__introsort_loop</code> but only its own overhead is accounted as 3.43%). There are tools for constructing <a href="https://www.brendangregg.com/flamegraphs.html">flame graphs</a> out of perf reports to make them more clear. You also need to account for possible inlining, which is apparently what happened with <code>std::lower_bound</code> here. Perf also tracks shared libraries (like <code>libc</code>) and, in general, any other spawned processes: if you want, you can launch a web browser with perf and see what&rsquo;s happening inside.</p>
<p>Next, you can &ldquo;zoom in&rdquo; on any of these functions, and, among others things, it will offer to show you its disassembly with an associated heatmap. For example, here is the assembly for <code>query</code>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-asm" data-lang="asm"><span class="line"><span class="cl">       <span class="err">│20:</span> <span class="err">→</span> <span class="nf">call</span>   <span class="no">rand@plt</span>
</span></span><span class="line"><span class="cl">       <span class="err">│</span>      <span class="nf">mov</span>    <span class="nv">%r12</span><span class="p">,</span><span class="nv">%rsi</span>
</span></span><span class="line"><span class="cl">       <span class="err">│</span>      <span class="nf">mov</span>    <span class="nv">%eax</span><span class="p">,</span><span class="nv">%edi</span>
</span></span><span class="line"><span class="cl">       <span class="err">│</span>      <span class="nf">mov</span>    <span class="no">$0xf4240</span><span class="p">,</span><span class="nv">%eax</span>
</span></span><span class="line"><span class="cl">       <span class="err">│</span>      <span class="nf">nop</span>    
</span></span><span class="line"><span class="cl">       <span class="err">│</span><span class="mi">30</span><span class="p">:</span>   <span class="no">test</span>   <span class="nv">%rax</span><span class="p">,</span><span class="nv">%rax</span>
</span></span><span class="line"><span class="cl">  <span class="err">4</span><span class="nf">.57</span> <span class="err">│</span>    <span class="err">↓</span> <span class="no">jle</span>    <span class="mi">52</span>
</span></span><span class="line"><span class="cl">       <span class="err">│35:</span>   <span class="nf">mov</span>    <span class="nv">%rax</span><span class="p">,</span><span class="nv">%rdx</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">.52</span> <span class="err">│</span>      <span class="no">sar</span>    <span class="nv">%rdx</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">.33</span> <span class="err">│</span>      <span class="no">lea</span>    <span class="p">(</span><span class="nv">%rsi</span><span class="p">,</span><span class="nv">%rdx</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span><span class="nv">%rcx</span>
</span></span><span class="line"><span class="cl">  <span class="err">4</span><span class="nf">.30</span> <span class="err">│</span>      <span class="no">cmp</span>    <span class="p">(</span><span class="nv">%rcx</span><span class="p">),</span><span class="nv">%edi</span>
</span></span><span class="line"><span class="cl"> <span class="err">65</span><span class="nf">.39</span> <span class="err">│</span>    <span class="err">↓</span> <span class="no">jle</span>    <span class="no">b0</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">.07</span> <span class="err">│</span>      <span class="no">sub</span>    <span class="nv">%rdx</span><span class="p">,</span><span class="nv">%rax</span>
</span></span><span class="line"><span class="cl">  <span class="err">9</span><span class="nf">.32</span> <span class="err">│</span>      <span class="no">lea</span>    <span class="mi">0x4</span><span class="p">(</span><span class="nv">%rcx</span><span class="p">),</span><span class="nv">%rsi</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">.06</span> <span class="err">│</span>      <span class="no">dec</span>    <span class="nv">%rax</span>
</span></span><span class="line"><span class="cl">  <span class="err">1</span><span class="nf">.37</span> <span class="err">│</span>      <span class="no">test</span>   <span class="nv">%rax</span><span class="p">,</span><span class="nv">%rax</span>
</span></span><span class="line"><span class="cl">  <span class="err">1</span><span class="nf">.11</span> <span class="err">│</span>    <span class="err">↑</span> <span class="no">jg</span>     <span class="mi">35</span>
</span></span><span class="line"><span class="cl">       <span class="err">│52:</span>   <span class="nf">sub</span>    <span class="nv">%r12</span><span class="p">,</span><span class="nv">%rsi</span>
</span></span><span class="line"><span class="cl">  <span class="err">2</span><span class="nf">.22</span> <span class="err">│</span>      <span class="no">sar</span>    <span class="no">$0x2</span><span class="p">,</span><span class="nv">%rsi</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">.33</span> <span class="err">│</span>      <span class="no">add</span>    <span class="nv">%esi</span><span class="p">,</span><span class="nv">%ebp</span>
</span></span><span class="line"><span class="cl">  <span class="err">0</span><span class="nf">.20</span> <span class="err">│</span>      <span class="no">dec</span>    <span class="nv">%ebx</span>
</span></span><span class="line"><span class="cl">       <span class="err">│</span>    <span class="err">↑</span> <span class="nf">jne</span>    <span class="mi">20</span>
</span></span></code></pre></div><p>On the left column is the fraction of times that the instruction pointer stopped on a specific line. You can see that we spend ~65% of the time on the jump instruction because it has a comparison operator before it, indicating that the control flow waits there for this comparison to be decided.</p>
<p>Because of intricacies such as <a href="/hpc/pipelining">pipelining</a> and out-of-order execution, &ldquo;now&rdquo; is not a well-defined concept in modern CPUs, so the data is slightly inaccurate as the instruction pointer drifts a little bit forward. The instruction-level data is still useful, but at the individual cycle level, we need to switch to <a href="../simulation">something more precise</a>.</p>
<!-- flame graphs -->

      
    
  



        </article>
        <div class='nextprev'>
  
    
      
      

      
      
      
        
      
        
          
        
      
        
      
        
      
        
      
        
      

      
        <div class='left'>
        
          <a href='https://en.algorithmica.org/hpc/profiling/instrumentation/' id='prev-article'>← Instrumentation</a>
        
        </div>
        <div class='right'>
        
          <a href='https://en.algorithmica.org/hpc/profiling/simulation/' id='next-article'>Program Simulation →</a>
        
        </div>
      
    
  
</div>

      </main>
      <footer>
  Copyright 2021–2022 Sergey Slotin
  <br>
   
</footer>

    </div>
  </body>
</html>
